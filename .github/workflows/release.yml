name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags starting with 'v' (e.g., v1.0.0, v1.2.3)

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build executable
        run: npm run build:exe
      
      - name: Extract version from tag
        id: tag-version
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Tag: $tag"
          echo "Version: $version"
      
      - name: Get short SHA
        id: commit-sha
        run: |
          $sha = $env:GITHUB_SHA.Substring(0, 7)
          echo "sha=$sha" >> $env:GITHUB_OUTPUT
          echo "Commit SHA: $sha"
      
      - name: Find executable
        id: find-exe
        run: |
          $exePath = Get-ChildItem -Path dist -Filter "*.exe" | Select-Object -First 1
          if (-not $exePath) {
            Write-Error "Executable not found in dist folder"
            exit 1
          }
          $exeName = $exePath.Name
          $exeSize = [math]::Round($exePath.Length / 1MB, 2)
          echo "exe-name=$exeName" >> $env:GITHUB_OUTPUT
          echo "Executable: $exeName"
          echo "Size: $exeSize MB"
          echo "Full path: $($exePath.FullName)"
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Release ${{ github.ref_name }}
            
            **Commit:** `${{ steps.commit-sha.outputs.sha }}`
            
            ## Quick Start
            
            1. Download `${{ steps.find-exe.outputs.exe-name }}` below
            2. Place it in a folder of your choice
            3. Double-click to run (may require admin elevation to edit hosts file)
            4. Follow the console instructions to set up your files
            
            ## Setup Instructions
            
            After first run, the executable will create:
            - `config.json` template (edit this to configure your file paths)
            - `img/` folder (place your Pokemon images here)
            - `txt/` folder (place your counter files here, e.g., `shiny.txt`, `failed_catches.txt`)
            
            Edit `config.json` to point to your files and images, then run the executable again.
            
            ## Usage
            
            Once running, add `http://shiny.local` as a link source in TikTok Live Studio.
            
            **Note:** This executable does not include any Pokemon images or copyrighted materials. You must provide your own images and text files.
          files: dist/${{ steps.find-exe.outputs.exe-name }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

